<launch>
	<arg name="camera_name"          default="oak" />
    <arg name="urdf_file"            default="$(find my_drone)/urdf/drone.urdf" />
    <arg name="oakd_params_file"     default="$(find my_drone)/config/oakd_params.yaml" />
    <arg name="rtabmap_params_file"  default="$(find my_drone)/config/rtabmap_params.yaml" />
    <arg name="parent_frame"         default="base_link" />
	
	
	<param name="robot_description" textfile="$(arg urdf_file)" />
    <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher" />

    <!-- Publish a static transform from map -> odom. RTAB-Map will publish the odom -> base_link transform. -->
    <node pkg="tf" type="static_transform_publisher" name="map_to_odom_broadcaster" args="0 0 0 0 0 0 map odom 100" />
	
	<include file="$(find depthai_ros_driver)/launch/camera.launch">
        <arg name="name"                value="$(arg camera_name)"/>
        <arg name="params_file"         value="$(arg oakd_params_file)"/>
        <arg name="parent_frame"        value="$(arg parent_frame)"/>
    </include>
	
	
	<group ns="rtabmap">
        <!-- RGB-D Odometry Node -->
        <node pkg="rtabmap_odom" type="rgbd_odometry" name="rgbd_odometry" output="screen">
            <!-- Load our custom parameters for better performance -->
            <rosparam file="$(arg rtabmap_params_file)" command="load" />
            
            <param name="frame_id" type="string" value="base_link"/>
            <param name="odom_frame_id" type="string" value="odom"/>
            <param name="subscribe_rgbd" type="bool" value="true"/>
            <param name="approx_sync" type="bool" value="true"/>
            
            <!-- Remap the synchronized rgbd_image topic from the sync nodelet -->
            <remap from="rgbd_image" to="/rgbd_image"/>
            <!-- Also provide the IMU data to RTAB-Map for better accuracy -->
            <remap from="imu" to="/$(arg camera_name)/imu/data"/>
        </node>

        <!-- Synchronization Nodelet -->
        <!-- This combines the separate camera streams into a single synchronized topic for RTAB-Map -->
        <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="standalone rtabmap_sync/rgbd_sync" output="screen">
            <remap from="rgb/image"       to="/$(arg camera_name)/rgb/preview/image_raw"/>
            <remap from="depth/image"     to="/$(arg camera_name)/stereo/image_raw"/>
            <remap from="rgb/camera_info" to="/$(arg camera_name)/rgb/camera_info"/>
            <remap from="rgbd_image"      to="/rgbd_image" />
            <param name="approx_sync" type="bool" value="true"/>
        </node>
    </group>
	
	
	<include file="$(find map_manager)/launch/dynamic_map.launch" />
	
	<node name="rviz" pkg="rviz" type="rviz" args="-d $(find onboard_detector)/rviz/uav_simulator.rviz" required="true" />
	

</launch>