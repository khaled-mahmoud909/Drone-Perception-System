<?xml version="1.0"?>
<launch>

    <arg name="rtabmap_enabled"     default="true"/>
    <arg name="rtabmap_viz_enabled" default="false"/>

    <arg name="name" default="oak" />
    <arg name="params_file" default="$(find my_drone)/config/oakd_params.yaml" />

    <arg name="cam_pos_x"   default="0.15" /> <arg name="cam_pos_y"   default="0.0" />  <arg name="cam_pos_z"   default="-0.1" />
    <arg name="cam_roll"    default="0.0" />  <arg name="cam_pitch"   default="0.0" />  <arg name="cam_yaw"     default="0.0" />
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_camera_broadcaster"
          args="$(arg cam_pos_x) $(arg cam_pos_y) $(arg cam_pos_z) $(arg cam_yaw) $(arg cam_pitch) $(arg cam_roll) base_link oak-d-base-frame" />

    <include file="$(find depthai_ros_driver)/launch/camera.launch">
        <arg name="name" value="$(arg name)"/>
        <arg name="params_file" value="$(arg params_file)"/>
    </include>

    <node type="rgbd_odometry" name="rgbd_odometry" pkg="rtabmap_odom" output="screen">
        <remap from="rgb/image" to="$(arg name)/rgb/preview/image_raw"/>
        <remap from="rgb/camera_info" to="$(arg name)/rgb/preview/camera_info"/>
        <remap from="depth/image" to="$(arg name)/stereo/image_raw"/>
        <remap from="imu/data" to="$(arg name)/imu/data"/> <param name="frame_id" type="string" value="base_link"/>
        <rosparam param="subscribe_depth">True</rosparam>
        <rosparam param="approx_sync">True</rosparam>
        <rosparam param="approx_sync_max_interval">0.1</rosparam>
        <param name="wait_for_transform" type="double" value="0.2"/>

        <param name="Odom/UpdateRate" type="string" value="20"/>
        <param name="Odom/ScanMatching" type="string" value="false"/>
        <param name="Vis/MaxFeatures" type="string" value="500"/>

        <param name="Odom/Holonomic" type="bool" value="true" />
        <param name="tf_tolerance" type="double" value="0.5"/>
        <param name="Odom/Strategy" type="string" value="0"/>
        <param name="Vis/MinInliers" type="string" value="25"/>
    </node>

    <group if="$(arg rtabmap_enabled)">
        <node type="rtabmap" name="rtabmap" pkg="rtabmap_slam" output="screen" args="-d">
            <remap from="rgb/image" to="$(arg name)/rgb/preview/image_raw"/>
            <remap from="rgb/camera_info" to="$(arg name)/rgb/preview/camera_info"/>
            <remap from="depth/image" to="$(arg name)/stereo/image_raw"/>
            <remap from="imu/data" to="$(arg name)/imu/data"/> <param name="frame_id" type="string" value="base_link"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_imu" type="bool" value="true"/> <param name="approx_sync" type="bool" value="true"/>
            
            <param name="Reg/Force3DoF" type="bool" value="true"/> <param name="tf_tolerance" type="double" value="0.5"/>
            <param name="wait_imu_to_init" type="bool" value="true"/>
            <rosparam param="Rtabmap/DetectionRate">3.5</rosparam>

            <param name="Grid/FromDepth" type="bool" value="true"/>
            <param name="Grid/CellSize" type="double" value="0.05"/>
            <param name="Grid/RangeMax" type="double" value="3.0"/>
            <param name="Grid/RayTracing" type="bool" value="true"/>
            <param name="Grid/ClusterRadius" type="double" value="0.1"/>
            <param name="Grid/MinClusterSize" type="int" value="10"/>
            <param name="Grid/MaxObstacleHeight" type="double" value="1.8"/> </node>
    </group>

    <group if="$(arg rtabmap_viz_enabled)">
        <node type="rtabmap_viz" name="rtabmap_viz" pkg="rtabmap_viz">
            <remap from="rgb/image" to="$(arg name)/rgb/preview/image_raw"/>
            <remap from="rgb/camera_info" to="$(arg name)/rgb/preview/camera_info"/>
            <remap from="depth/image" to="$(arg name)/stereo/image_raw"/>
            <remap from="odom" to="/rtabmap/odom"/>
        </node>
    </group>

</launch>
